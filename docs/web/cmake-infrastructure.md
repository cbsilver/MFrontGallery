---
title: CMake infrastructure
author: Thomas Helfer
date: 18/12/2021
lang: en-EN
link-citations: true
colorlinks: true
figPrefixTemplate: "$$i$$"
tblPrefixTemplate: "$$i$$"
secPrefixTemplate: "$$i$$"
eqnPrefixTemplate: "($$i$$)"
---

This document gives an overview of the [`CMake`](https://cmake.org)
infrastructure of the `MFrontGallery` and `MFrontMaterials` projects.

This infrastructure is fully contained in the `cmake/modules` directory,
the file `cmake/modules/mfm.cmake` being the main entry point.

Section @sec:mfm:cmake:main_functions describes the main `cmake`
functions provided by this infrastructure from the point of view of the
maintainer and developper of a material knowledge management project. It
mostly convers:

- functions used to compile `MFront` files related to material
  properties, behaviours and models.
- functions related to documentation and website generation.

Section @sec:mfm:cmake:cmake_modules describes the contents of the
`cmake/modules` directory.

# Main functions {#sec:mfm:cmake:main_functions}

## The `mfront_properties_library` function

The `mfront_behaviours_library` function adds shared libraries to the
project related to `MFront`' behaviours. The number of added shared
libraries depends on the number of (material properties) interfaces
selected when the project is configured (see the [`install` page for
details](install.html`)).

### Usage

The following example shows how to create libraries associated with a
material called `VanadiumAlloy` from a single `MFront` source file named
`VanadiumAlloy_YoungModulus_SRMA.mfront`:

~~~{.cmake}
mfront_properties_library(VanadiumAlloy
  VanadiumAlloy_YoungModulus_SRMA)
~~~

Note that the `.mfront` suffix has been omitted in this declaration.

Internally, the `mfront_properties_library` function forward is
arguments to the `parse_mfront_library_sources` function and use its
results to add the shared libraries properly. See Section
@sec:mfm:cmake:parse_mfront_library_sources for the available options.

The output generated by this function during the `cmake` configuration
process is similar to the following:

~~~~{.bash}
-- Treating interface cyrano
-- Adding library : VanadiumAlloyMaterialProperties-cyrano (/home/th202608/codes/MFrontGallery/master/src/build/materials/VanadiumAlloy/properties/cyrano/src/VanadiumAlloy_YoungModulus_SRMA-mfront.cxx)
-- Treating interface castem
-- Adding library : VanadiumAlloyMaterialProperties-castem (/home/th202608/codes/MFrontGallery/master/src/build/materials/VanadiumAlloy/properties/castem/src/VanadiumAlloy_YoungModulus_SRMA-mfront.cxx)
....
~~~~

which lists the shared libraries that will be compiled and the sources
that will be generated by `MFront`. One may notice that each shared
library is compiled in its own directory.

Internally, the `mfront_properties_library` relies on the `mfront-query`
to get the list generated sources and handle dependencies to other
`MFront` files and so on.

Regarding dependencies to other `MFront` files, the current directory
`${CMAKE_SOURCE_DIR}/materials/${mat}/properties` is automatically added
to the `MFront` search paths, where:

- `${CMAKE_SOURCE_DIR}` denotes the top level directory of the project
- `${mat}` is the name of the material passed as first argument to the
  `mfront_properties_library`.

Other search paths can be added by using any of the options
`SEARCH_PATH` or `SEARCH_PATHS`, as described in Section
@sec:mfm:cmake:parse_mfront_library_sources.

## The `mfront_behaviours_library` function

The `mfront_behaviours_library` function adds shared libraries to the
project related to `MFront`' behaviours. The number of added shared
libraries depends on the number of (behaviour) interfaces selected when
the project is configured (see the [`install` page for
details](install.html`)).

### Usage

A typical usage of the `mfront_behaviours_library` is the following:

~~~{.cmake}
mfront_behaviours_library(Concrete
  ConcreteBurger_EDF_CIWAP_2021
  ConcreteBurger_EDF_CIWAP_2021_v2)
~~~

which declares a set of shared libraries associated with the `Concrete`
material. Those shared libraries are generated using two `MFront` files
named respectively `ConcreteBurger_EDF_CIWAP_2021.mfront` and
`ConcreteBurger_EDF_CIWAP_2021_v2.mfront` (See Section
@sec:mfm:cmake:mfront_behaviours_library:sources for details).

Note that the `.mfront` suffix has been omitted in this declaration.

~~~~{.bash}
-- ConcreteBurger_EDF_CIWAP_2021 has been discarded for interface calculix (behaviours with external state variable other  than the temperature are not supported)
-- ConcreteBurger_EDF_CIWAP_2021_v2 has been discarded for interface calculix (behaviours with external state variable other  than the temperature are not supported)
-- No sources selected for library CONCRETECALCULIXBEHAVIOURS for interface calculix
-- ConcreteBurger_EDF_CIWAP_2021 has been discarded for interface ansys (behaviours with external state variable other  than the temperature are not supported)
-- ConcreteBurger_EDF_CIWAP_2021_v2 has been discarded for interface ansys (behaviours with external state variable other  than the temperature are not supported)
-- No sources selected for library CONCRETEANSYSBEHAVIOURS for interface ansys
-- Adding library : CONCRETEABAQUSBEHAVIOURS (/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/abaqus/src/abaqusConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/abaqus/src/ConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/abaqus/src/abaqusConcreteBurger_EDF_CIWAP_2021_v2.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/abaqus/src/ConcreteBurger_EDF_CIWAP_2021_v2.cxx)
-- Adding library : ConcreteBehaviours-cyrano (/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/cyrano/src/cyranoConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/cyrano/src/ConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/cyrano/src/cyranoConcreteBurger_EDF_CIWAP_2021_v2.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/cyrano/src/ConcreteBurger_EDF_CIWAP_2021_v2.cxx)
-- ConcreteBurger_EDF_CIWAP_2021 has been discarded for interface epx (small strain behaviours are not supported)
-- ConcreteBurger_EDF_CIWAP_2021_v2 has been discarded for interface epx (small strain behaviours are not supported)
-- No sources selected for library ConcreteBehaviours-epx for interface epx
-- ConcreteBurger_EDF_CIWAP_2021 has been discarded for interface dianafea (behaviours with external state variable other  than the temperature are not supported)
-- ConcreteBurger_EDF_CIWAP_2021_v2 has been discarded for interface dianafea (behaviours with external state variable other  than the temperature are not supported)
-- No sources selected for library ConcreteDianaFEABehaviours for interface dianafea
-- Adding library : ConcreteBehaviours-aster (/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/aster/src/asterConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/aster/src/ConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/aster/src/asterConcreteBurger_EDF_CIWAP_2021_v2.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/aster/src/ConcreteBurger_EDF_CIWAP_2021_v2.cxx)
-- Adding library : ConcreteBehaviours (/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/castem/src/umatConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/castem/src/ConcreteBurger_EDF_CIWAP_2021.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/castem/src/umatConcreteBurger_EDF_CIWAP_2021_v2.cxx;/home/th202608/codes/MFrontGallery/master/src/build/materials/Concrete/behaviours/castem/src/ConcreteBurger_EDF_CIWAP_2021_v2.cxx)
....
~~~~

which lists the shared libraries that will be compiled and the sources
that will be generated by `MFront`. One may notice that each shared
library is compiled in its own directory.

One may also notice that the behaviours considered are not compatible
with some of the selected behaviour interfaces and are thus discarded:

- Those behaviours are not compatible with the `dianafea`, `calculix`
  and `ansys` interfaces because it declares an external state variable
  which is not the temperature and this is not supported by those
  interfaces.
- Those behaviours are not compatible with the `epx` (Europlexus)
  interface because this solver only supports finite strain behaviours.

In this example, no shared libraries for the `Concrete` material will
be generated for the interfaces `dianafea`, `calculix`, `ansys` and
`epx` interfaces since no `MFront` are compatible with them.

Internally, the `mfront_behaviours_library` function forward is
arguments to the `parse_mfront_library_sources` function and use its
results to add the shared libraries properly. See Section
@sec:mfm:cmake:parse_mfront_library_sources for the available options.

### Treatment of the sources {#sec:mfm:cmake:mfront_behaviours_library:sources}

For each shared library to be added, each source returned in the
`mfront_sources` variable by the `parse_mfront_library_sources` is
treated as follows:

- If the file `@source@.mfront` (where `@source@` is the name of the
  considered source) exists in the current source directory, then it is
  treated as an `MFront` source file.
- If the file `@source@.mfront.in` (where `@source@` is the name of the
  considered source) exists in the current source directory, then it is
  automatically configured using `Ì€CMake`' `configure_file` command and
  the resulting file is treated as an `MFront` source file.
- If neither the `@source@.mfront` nor `@source@.mfront.in` exist in the
  current directory, the file `@source@` is added in the list of sources
  for the treated shared library. This file can be given by its full
  path, and is searched in the current source directory or the the
  current binary directory.

`MFront` source files are treated by:

- the `generate_mfront_doc` function which will generate a web page for
  this source file using the `mfront-doc` utility if the
  `enable-website` option has been choosen at the `CMake` configuration
  stage (see the [`install` page for details](install.html`)).
- 

## The `parse_mfront_library_sources` function {#sec:mfm:cmake:parse_mfront_library_sources}

The `parse_mfront_library_sources` function set the following variables
on output:

- `mfront_sources`: list of sources to be processed. In practice, this
  is the list of arguments which are not specifically treated.
- `mfront_search_paths`: list of search paths, i.e. list of directories
  where `MFront` shall search for auxiliary files (imported files,
  external material properties, external models.).
- `mfront_include_directories`: list of include directories. The include
  directories are added the compiler include directories.
- `mfront_link_libraries`: list of link libraries. Those link
  libraries are meant to be linked to the generated shared libraries.

The `parse_mfront_library_sources` function allows the following
options:

- `SOURCES` (the default): this option introduces new sources for the
  generated libraries. All subsequent arguments are treated as sources,
  up to the next option.
- `LINK_LIBRARY`: this option allows to define one link library by the
  next argument passed to the `parse_mfront_library_sources` function.
- `LINK_LIBRARIES`: all subsequent arguments are treated as link
  libraries, up to the next option.
- `SEARCH_PATH`: the next argument passed to the
  `parse_mfront_library_sources` function is added to the list of search
  paths.
- `SEARCH_PATHS`: all subsequent arguments are treated as `MFront`
  search path, up to the next option.
- `INCLUDE_DIRECTORY`: the next argument passed to the
  `parse_mfront_library_sources` function is added to the list of
  include directories.
- `INCLUDE_DIRECTORIES`: the next argument passed to the
  `parse_mfront_library_sources` function is added to the list of
  include directories.

## Functions related to tests based on `MTest`

## The `pandoc_html` function

# The `cmake/modules` directory {#sec:mfm:cmake:cmake_modules}


## Main files

### The `tfel.cmake` file

### Files related to `MFront` interfaces

### Files related to compiler support

